{% extends "base.html" %}
{% block title %}Rekomendasi Saham{% endblock %}

{% block content %}
<h1>ðŸš€ Rekomendasi Saham Anda</h1>

{% if recommendations is not none %}
<div class="card-grid">
    {% for rec in recommendations.to_dict('records') %}
    <div class="stock-card">
        
        <!-- Logo -->
        <img src="https://logo.clearbit.com/{{ rec['Ticker'] | lower }}.com" 
             alt="{{ rec['Ticker'] }} logo" 
             class="stock-logo"
             onerror="this.onerror=null; this.src='https://via.placeholder.com/40?text={{ rec['Ticker'] }}';">

        <h3>{{ rec['Ticker'] }}</h3>

        <!-- % Change Badge -->
        {% set first_price = price_trends[rec['Ticker']]['prices'][0] %}
        {% set last_price = price_trends[rec['Ticker']]['prices'][-1] %}
        {% set change = ((last_price - first_price) / first_price * 100) | round(2) %}
        <span class="badge {{ 'up' if change > 0 else 'down' }}">
            {{ '+' if change > 0 else '' }}{{ change }}%
        </span>

        <p>Ranking: <strong>#{{ loop.index }}</strong></p>
        <p>Preference: {{ '%.4f'|format(rec['Preference Value']) }}</p>

        <!-- Chart -->
        <canvas class="mini-chart" id="chart-{{ rec['Ticker'] }}"></canvas>

        <a href="https://finance.yahoo.com/quote/{{ rec['Ticker'] }}" target="_blank">ðŸ”Ž Detail Saham</a>
    </div>
    {% endfor %}
</div>

<!-- Tombol Aksi -->
<div class="btn-group">
    <a href="{{ url_for('analysis') }}" class="btn btn-analyze">ðŸ”„ Analisis Baru</a>
    <a href="{{ url_for('output') }}" class="btn">ðŸ“„ Detail Perhitungan</a>
</div>

{% else %}
<p>Tidak ada rekomendasi. Silakan analisis dulu.</p>
<a href="{{ url_for('analysis') }}" class="btn">Mulai Analisis</a>
{% endif %}
{% endblock %}

{% block scripts %}
<style>
    .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .stock-card {
        background: #fff;
        border: 2px solid #eee;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stock-card:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 20px rgba(0,0,0,0.15);
    }

    .stock-logo {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: contain;
        margin-bottom: 10px;
    }

    .badge {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        margin: 10px 0;
    }

    .badge.up {
        background-color: #e6f4ea;
        color: #34a853;
    }

    .badge.down {
        background-color: #fce8e6;
        color: #ea4335;
    }

    .mini-chart {
        margin: 10px 0;
    }

    .btn-group {
        margin-top: 30px;
        text-align: center;
    }

    .btn {
        display: inline-block;
        padding: 10px 15px;
        color: white;
        background-color: #007bff;
        text-decoration: none;
        border-radius: 5px;
        margin: 5px;
    }

    .btn:hover {
        background-color: #0056b3;
    }

    @media (max-width: 600px) {
        .card-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartData = {{ price_trends | tojson }};
    Object.keys(chartData).forEach(ticker => {
        const ctx = document.getElementById('chart-' + ticker).getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData[ticker].dates,
                datasets: [{
                    data: chartData[ticker].prices,
                    borderColor: chartData[ticker].prices.at(-1) >= chartData[ticker].prices[0] ? '#34a853' : '#ea4335',
                    backgroundColor: 'rgba(0,0,0,0.03)',
                    borderWidth: 3,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                plugins: { legend: { display: false }},
                scales: { x: { display: false }, y: { display: false }},
                elements: { line: { borderCapStyle: 'round' }}
            }
        });
    });
</script>
{% endblock %}
